<div class="container-fluid">
  <!-- Header -->
  <div class="row">
    <div class="col-8">
      <h5>Recetas Pre-elaboradas</h5>
      <span>Productos combinados para usar en tus escandallos</span>
    </div>
    <div class="col text-end">
      <button class="btn btn-danger" (click)="abrirModalNuevo()">
        <i class="bi bi-plus-lg me-2"></i> Nueva Receta
      </button>
    </div>
  </div>

  <!-- Estadísticas -->
  <div class="row mt-4">
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h2 class="text-primary mb-0">{{ totalRecetas }}</h2>
          <span class="text-muted">Total Recetas</span>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h2 class="text-success mb-0">{{ recetasActivas }}</h2>
          <span class="text-muted">Activas</span>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h2 class="text-info mb-0">{{ totalIngredientes }}</h2>
          <span class="text-muted">Total Ingredientes</span>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <h2 class="text-warning mb-0">
            {{ costoPromedio | currency:'EUR':'symbol':'1.2-2' }}
          </h2>
          <span class="text-muted">Costo Promedio</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Recetas -->
  <div class="row mt-4">
    <div *ngIf="recetas.length === 0" class="col-12 text-center py-5">
      <i class="bi bi-inbox fs-1 text-muted"></i>
      <h5 class="mt-3 text-muted">No hay recetas registradas</h5>
      <p class="text-muted">Crea tu primera receta para comenzar</p>
      <button class="btn btn-danger" (click)="abrirModalNuevo()">
        <i class="bi bi-plus me-1"></i>
        Nueva Receta
      </button>
    </div>

    <div class="col-12 col-md-6 col-lg-4 mb-4" *ngFor="let receta of recetas">
      <div
        class="card shadow-sm border-0 h-100"
        style="cursor: pointer"
        (click)="verDetalleReceta(receta)"
      >
        <div class="card-body p-4">
          <!-- Header -->
          <div class="d-flex align-items-start mb-3">
            <div
              class="rounded-circle me-3 d-flex justify-content-center align-items-center"
              style="
                background-color: #6c757d;
                width: 48px;
                height: 48px;
                min-width: 48px;
              "
            >
              <i class="bi bi-cup-straw text-white fs-5"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-1 fw-bold">{{ receta.nombre }}</h6>
              <span
                class="badge rounded-pill"
                [ngClass]="getCategoriaBadgeClass(receta.categoriaId)"
              >
                {{ getCategoriaNombre(receta.categoriaId) }}
              </span>
            </div>
          </div>

          <!-- Costo -->
          <div class="mb-3">
            <div class="text-muted small">Costo Total</div>
            <div class="fw-bold text-warning" style="font-size: 1.3rem">
              <span
                *ngIf="receta.costoTotal !== undefined && receta.costoTotal !== null && isFinite(receta.costoTotal); else noCosto"
              >
                {{ receta.costoTotal | currency:'EUR':'symbol':'1.2-2' }}
              </span>
              <ng-template #noCosto>
                <span class="text-muted">€0.00</span>
              </ng-template>
            </div>
          </div>

          <!-- Ingredientes -->
          <div class="mb-3">
            <small class="text-muted d-block mb-2">
              <i class="bi bi-list-ul me-1"></i>
              Ingredientes:
            </small>
            <div class="d-flex flex-wrap gap-1">
              <span
                class="badge bg-light text-dark"
                *ngFor="let ing of receta.ingredientes.slice(0, 3)"
              >
                {{ getProductoNombre(ing.productoId) }}
              </span>
              <span
                class="badge bg-light text-dark"
                *ngIf="receta.ingredientes.length > 3"
              >
                +{{ receta.ingredientes.length - 3 }} más
              </span>
            </div>
          </div>

          <!-- Estado -->
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="bi bi-box-seam me-1"></i>
              {{ receta.ingredientes.length }} ingredientes
            </small>
            <span
              class="badge"
              [ngClass]="receta.activo ? 'bg-success' : 'bg-secondary'"
            >
              <i
                class="bi"
                [ngClass]="receta.activo ? 'bi-check-circle' : 'bi-x-circle'"
              ></i>
              {{ receta.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Vista Detallada -->
<div
  class="modal fade"
  id="detalleRecetaModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <div class="d-flex align-items-center">
          <div
            class="rounded-circle me-3 d-flex justify-content-center align-items-center"
            style="background-color: #6c757d; width: 56px; height: 56px"
          >
            <i class="bi bi-cup-straw text-white fs-3"></i>
          </div>
          <div>
            <h4 class="mb-0">{{ recetaSeleccionada?.nombre }}</h4>
          </div>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body pt-3" *ngIf="recetaSeleccionada">
        <!-- Badge de categoría y estado -->
        <div class="mb-4">
          <span
            class="badge px-3 py-2 me-2"
            [ngClass]="getCategoriaBadgeClass(recetaSeleccionada.categoriaId)"
          >
            <i class="bi bi-tag-fill me-1"></i>
            {{ getCategoriaNombre(recetaSeleccionada.categoriaId) }}
          </span>
          <span
            class="badge px-3 py-2"
            [ngClass]="recetaSeleccionada.activo ? 'bg-success' : 'bg-secondary'"
          >
            <i
              class="bi"
              [ngClass]="recetaSeleccionada.activo ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"
            ></i>
            {{ recetaSeleccionada.activo ? 'Activo' : 'Inactivo' }}
          </span>
        </div>

        <!-- Costo principal -->
        <div class="row g-3 mb-3">
          <div class="col-md-12">
            <div class="card border-0 bg-warning bg-opacity-10 h-100">
              <div class="card-body text-center">
                <i class="bi bi-cash-coin text-warning fs-2 d-block mb-2"></i>
                <h3 class="mb-0 text-warning">
                  {{ recetaSeleccionada.costoTotal |
                  currency:'EUR':'symbol':'1.2-2' }}
                </h3>
                <small class="text-muted">Costo Total de la Receta</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Desglose de Costos -->
        <div class="card border-0 bg-light mb-3">
          <div class="card-body">
            <h6 class="mb-3">
              <i class="bi bi-calculator me-2 text-primary"></i>
              Desglose de Costos
            </h6>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Ingrediente</th>
                    <th class="text-end">Cantidad</th>
                    <th class="text-end">Costo</th>
                    <th class="text-end">%</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let ing of recetaSeleccionada.ingredientes">
                    <td>
                      <strong>{{ getProductoNombre(ing.productoId) }}</strong>
                      <br />
                      <small class="text-muted">
                        Costo/unidad: {{ (ing.costo || 0) / ing.cantidad |
                        currency:'EUR':'symbol':'1.3-3' }}
                      </small>
                    </td>
                    <td class="text-end">
                      {{ ing.cantidad }} {{ ing.unidadMedida }}
                    </td>
                    <td class="text-end">
                      {{ ing.costo | currency:'EUR':'symbol':'1.2-2' }}
                    </td>
                    <td class="text-end">
                      <span class="badge bg-secondary">
                        {{ calcularPorcentajeCosto(ing, recetaSeleccionada) |
                        number:'1.1-1' }}%
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Información adicional -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-3">
                  <i class="bi bi-list-ul me-2 text-primary"></i>
                  Ingredientes
                </h6>
                <div class="d-flex align-items-center">
                  <i class="bi bi-box-seam fs-2 text-primary me-3"></i>
                  <div>
                    <h3 class="mb-0">
                      {{ recetaSeleccionada.ingredientes.length }}
                    </h3>
                    <small class="text-muted">productos utilizados</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-3">
                  <i class="bi bi-cash-stack me-2 text-primary"></i>
                  Costo Total
                </h6>
                <div class="d-flex align-items-center">
                  <i class="bi bi-calculator fs-2 text-primary me-3"></i>
                  <div>
                    <h3 class="mb-0">
                      {{ recetaSeleccionada.costoTotal |
                      currency:'EUR':'symbol':'1.2-2' }}
                    </h3>
                    <small class="text-muted">costo de preparación</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notas de preparación -->
        <div
          class="card border-0 bg-primary bg-opacity-10 mt-3"
          *ngIf="recetaSeleccionada.notasPreparacion"
        >
          <div class="card-body">
            <h6 class="mb-2">
              <i class="bi bi-journal-text me-2 text-primary"></i>
              Notas de Preparación
            </h6>
            <p class="mb-0 small">{{ recetaSeleccionada.notasPreparacion }}</p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-2"></i>Cerrar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="editarDesdeDetalle()"
        >
          <i class="bi bi-pencil-fill me-2"></i>Editar
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="eliminarDesdeDetalle()"
        >
          <i class="bi bi-trash3-fill me-2"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Creación/Edición -->
<div
  class="modal fade"
  id="recetaModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ recetaForm.get('id')?.value ? 'Editar Receta' : 'Nueva Receta' }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Información básica -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre</label>
              <input
                type="text"
                class="form-control"
                formControlName="nombre"
                placeholder="Ej: Puré de Papa"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Categoría</label>
              <select class="form-select" formControlName="categoriaId">
                <option value="">Seleccionar categoría</option>
                <option *ngFor="let cat of categorias" [value]="cat.id">
                  {{ cat.nombre }}
                </option>
              </select>
            </div>
          </div>

          <!-- Notas de preparación -->
          <div class="mb-3">
            <label class="form-label">Notas de Preparación</label>
            <textarea
              class="form-control"
              formControlName="notasPreparacion"
              rows="2"
              placeholder="Instrucciones especiales o notas importantes"
            ></textarea>
          </div>

          <!-- Ingredientes -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Ingredientes</label>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                (click)="agregarIngrediente()"
              >
                <i class="bi bi-plus me-1"></i>Agregar
              </button>
            </div>

            <div formArrayName="ingredientes">
              <div
                *ngFor="let ingrediente of ingredientes.controls; let i = index"
                [formGroupName]="i"
                class="card mb-2"
              >
                <div class="card-body p-3">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label small text-muted mb-1"
                        >Producto</label
                      >
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        #productoInput
                        [value]="getProductoNombreById(ingrediente.get('productoId')?.value)"
                        (input)="onProductoInput(i, $event)"
                        (change)="onProductoInput(i, $event)"
                        (blur)="onProductoBlur(i, $event)"
                        [attr.list]="'productos-list-' + i"
                        placeholder="Buscar producto..."
                        autocomplete="off"
                      />
                      <datalist [id]="'productos-list-' + i">
                        <option
                          *ngFor="let producto of productos"
                          [value]="producto.nombre"
                        >
                          Stock: {{ producto.cantidad }} {{
                          producto.unidadMedida }} - {{ producto.costo |
                          currency:'EUR':'symbol':'1.2-2' }}
                        </option>
                      </datalist>
                      <input type="hidden" formControlName="productoId" />

                      <!-- Info del producto seleccionado -->
                      <div
                        *ngIf="getProductoById(ingrediente.get('productoId')?.value) as producto"
                        class="mt-1"
                      >
                        <small class="text-success d-block">
                          <i class="bi bi-box-seam me-1"></i>
                          Stock: {{ producto.cantidad }} {{
                          producto.unidadMedida }}
                        </small>
                        <small class="text-info d-block">
                          <i class="bi bi-cash me-1"></i>
                          Costo: {{ producto.costo |
                          currency:'EUR':'symbol':'1.2-2' }}
                        </small>
                      </div>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label small text-muted mb-1"
                        >Cantidad</label
                      >
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="cantidad"
                        placeholder="0"
                        step="0.01"
                        min="0"
                        (input)="actualizarCostoIngrediente(i)"
                      />
                    </div>

                    <div class="col-md-2">
                      <label class="form-label small text-muted mb-1"
                        >Unidad</label
                      >
                      <select
                        class="form-select form-select-sm"
                        formControlName="unidadMedida"
                        (change)="actualizarCostoIngrediente(i)"
                      >
                        <option value="">Seleccionar</option>
                        <option
                          *ngFor="let unidad of getUnidadesCompatibles(ingrediente.get('productoId')?.value)"
                          [value]="unidad"
                        >
                          {{ unidad }}
                        </option>
                      </select>
                    </div>

                    <div class="col-md-3">
                      <label class="form-label small text-muted mb-1"
                        >Costo</label
                      >
                      <div class="input-group input-group-sm">
                        <span class="input-group-text">€</span>
                        <input
                          type="text"
                          class="form-control form-control-sm"
                          [value]="calcularCostoIngredientePreview(i) | currency:'EUR':'symbol-narrow':'1.3-3'"
                          readonly
                          style="background-color: #f8f9fa"
                        />
                      </div>
                    </div>

                    <div class="col-md-1">
                      <label class="form-label small text-muted mb-1"
                        >&nbsp;</label
                      >
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger w-100 d-block"
                        (click)="eliminarIngrediente(i)"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div
              *ngIf="ingredientes.length === 0"
              class="alert alert-info py-2 px-3"
            >
              <small>
                <i class="bi bi-info-circle me-1"></i>
                Haz clic en "Agregar" para añadir ingredientes a la receta
              </small>
            </div>
          </div>

          <!-- Preview de costos -->
          <div class="alert alert-info mb-3" *ngIf="ingredientes.length > 0">
            <h6 class="alert-heading">
              <i class="bi bi-calculator me-2"></i>
              Preview de Costos
            </h6>
            <div class="text-center">
              <small class="text-muted d-block">Costo Total</small>
              <strong class="fs-4 text-warning"
                >{{ costoPreview.costoTotal | currency:'EUR':'symbol':'1.2-2'
                }}</strong
              >
            </div>
          </div>

          <!-- Activo -->
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              formControlName="activo"
              id="activoCheck"
            />
            <label class="form-check-label" for="activoCheck"> Activo </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-danger">
            {{ recetaForm.get('id')?.value ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
