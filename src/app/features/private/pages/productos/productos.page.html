<div class="container-fluid">
  <div class="row">
    <div class="col-8">
      <h5>Gestión de Productos</h5>
      <span>Crea, edita y organiza todos tus productos.</span>
    </div>
    <div class="col text-end">
      <button class="btn btn-danger" (click)="abrirModalNuevo()">
        <i class="bi bi-plus-lg me-2"></i> Nuevo Producto
      </button>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="row d-flex align-items-center">
                    <div class="col-12 col-sm-4 mt-2">
                        <input type="text" class="form-control" placeholder="Buscar productos..." [formControl]="productSearch">
                    </div>
                    <div class="col-12 col-sm-3 mt-2">
                        <select class="form-select" [formControl]="categoryFilter">
                            <option value="all">Todas las categorías</option>
                            <option *ngFor="let categoria of categorias" [value]="categoria.id">{{ categoria.nombre }}</option>
                        </select>
                    </div>
                    <div class="col-12 col-sm-3 mt-2">
                        <select class="form-select" [formControl]="supplierFilter">
                            <option value="all">Todos los proveedores</option>
                            <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">{{ proveedor.nombre }}</option>
                        </select>
                    </div>
                    <div class="col-12 col-sm-2 mt-2">
                        <span><i class="bi bi-box text-primary"></i>&nbsp;{{ filteredProducts.length }}&nbsp;Productos</span>&nbsp;&nbsp;
                        <span><i class="bi bi-exclamation-circle text-danger"></i>&nbsp;{{ productosBajosEnStock }}&nbsp;Stock</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="row mt-4">
    <div *ngIf="filteredProducts.length === 0" class="col-12 text-center">
      <p class="text-muted">No se encontraron productos con los filtros seleccionados.</p>
    </div>
    <div class="col-12 col-sm-3 mb-4" *ngFor="let producto of filteredProducts">
      <div class="card shadow-sm border-0 h-100 position-relative"
           style="cursor: pointer;"
           (click)="verDetalleProducto(producto)"
           [class.border-warning]="!producto.esCombinado && (producto.stock || 0) <= (producto.stockMinimo || 0) && (producto.stock || 0) > 0"
           [class.border-danger]="!producto.esCombinado && (producto.stock || 0) === 0"
           [style.border-width]="(!producto.esCombinado && (producto.stock || 0) <= (producto.stockMinimo || 0)) ? '2px' : '1px'">

        <!-- Indicador de stock bajo/agotado -->
        <div *ngIf="!producto.esCombinado && (producto.stock || 0) <= (producto.stockMinimo || 0)"
             class="position-absolute top-0 end-0 m-2">
          <div *ngIf="(producto.stock || 0) === 0"
               class="badge bg-danger d-flex align-items-center gap-1 px-2 py-1"
               style="font-size: 0.7rem;">
            <i class="bi bi-exclamation-triangle-fill"></i>
            AGOTADO
          </div>
          <div *ngIf="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)"
               class="badge bg-warning text-dark d-flex align-items-center gap-1 px-2 py-1"
               style="font-size: 0.7rem;">
            <i class="bi bi-exclamation-circle-fill"></i>
            STOCK BAJO
          </div>
        </div>

        <!-- Barra de alerta en la parte superior -->
        <div *ngIf="!producto.esCombinado && (producto.stock || 0) <= (producto.stockMinimo || 0)"
             class="alert-bar position-absolute top-0 start-0 w-100"
             [class.bg-danger]="(producto.stock || 0) === 0"
             [class.bg-warning]="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)"
             style="height: 4px; border-radius: 0.375rem 0.375rem 0 0;"></div>

        <div class="card-body p-3">
          <!-- Header con título -->
          <div class="mb-3">
            <div class="flex-grow-1">
              <h6 class="mb-1 fw-bold"
                  [class.text-danger]="!producto.esCombinado && (producto.stock || 0) === 0"
                  [class.text-warning]="!producto.esCombinado && (producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)"
                  [class.text-dark]="producto.esCombinado || (producto.stock || 0) > (producto.stockMinimo || 0)">
                {{producto.nombre}}
              </h6>
              <p class="text-muted small mb-2">{{producto.descripcion}}</p>
              <div class="d-flex flex-wrap gap-1">
                <span class="badge rounded-pill"
                      [ngClass]="getCategoryBadgeClass(producto.categoriaId)"
                      style="font-size: 0.75rem;">
                  {{ getCategoryName(producto.categoriaId) }}
                </span>
                <span class="badge rounded-pill bg-secondary"
                      *ngIf="producto.familiaId"
                      style="font-size: 0.7rem;">
                  {{ getFamiliaName(producto.categoriaId, producto.familiaId) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Información del producto -->
          <div class="row mb-3">
            <div class="col-12 mb-2">
              <div class="text-muted small">Contenido por unidad</div>
              <div class="fw-bold text-info" style="font-size: 1rem;">
                {{ producto.cantidad }} {{ producto.unidadMedida }}
              </div>
            </div>
            <div class="col-6">
              <div class="text-muted small">Costo</div>
              <div class="fw-bold text-danger" style="font-size: 1.1rem;">
                {{ producto.costo | currency:'EUR':'symbol':'1.2-2' }}
              </div>
            </div>
            <div class="col-6" *ngIf="!producto.esCombinado">
              <div class="text-muted small">Stock (unidades)</div>
              <div class="fw-bold d-flex align-items-center gap-1" [class]="getStockClass(producto)">
                <span>{{ producto.stock || 0 }}</span>
                <i *ngIf="(producto.stock || 0) === 0" class="bi bi-exclamation-triangle-fill text-danger"></i>
                <i *ngIf="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)" class="bi bi-exclamation-circle-fill text-warning"></i>
              </div>
              <!-- Indicador de stock mínimo -->
              <div *ngIf="(producto.stock || 0) <= (producto.stockMinimo || 0)" class="small mt-1">
                <span class="text-muted">Mín: {{ producto.stockMinimo || 0 }}</span>
                <span *ngIf="(producto.stock || 0) === 0" class="text-danger ms-2">
                  <i class="bi bi-arrow-down-circle-fill me-1"></i>¡Reponer!
                </span>
                <span *ngIf="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)" class="text-warning ms-2">
                  <i class="bi bi-exclamation-circle me-1"></i>Bajo
                </span>
              </div>
            </div>
            <div class="col-6" *ngIf="producto.esCombinado">
              <div class="text-muted small">Tipo</div>
              <div class="fw-bold text-warning" style="font-size: 0.9rem;">
                Receta/Combinado
              </div>
            </div>
          </div>

          <!-- Alerta de stock en la parte inferior -->
          <div *ngIf="!producto.esCombinado && (producto.stock || 0) <= (producto.stockMinimo || 0)"
               class="alert py-2 px-3 mb-0 d-flex align-items-center"
               [class.alert-danger]="(producto.stock || 0) === 0"
               [class.alert-warning]="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)">
            <i class="bi me-2"
               [class.bi-exclamation-triangle-fill]="(producto.stock || 0) === 0"
               [class.bi-exclamation-circle-fill]="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)"></i>
            <small class="mb-0">
              <strong *ngIf="(producto.stock || 0) === 0">¡Stock agotado!</strong>
              <strong *ngIf="(producto.stock || 0) > 0 && (producto.stock || 0) <= (producto.stockMinimo || 0)">Stock bajo</strong>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Vista Detallada -->
<div class="modal fade" id="detalleProductoModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <div class="d-flex align-items-center w-100">
          <div class="rounded-circle me-3 d-flex justify-content-center align-items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 56px; height: 56px">
            <i class="bi bi-box-seam-fill text-white fs-3"></i>
          </div>
          <div class="flex-grow-1">
            <h4 class="mb-1">{{productoSeleccionado?.nombre}}</h4>
            <p class="text-muted mb-0 small">{{productoSeleccionado?.descripcion}}</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-3" *ngIf="productoSeleccionado">
        <!-- Badges de categoría y tipo -->
        <div class="mb-4 d-flex gap-2 align-items-center">
          <span class="badge rounded-pill px-3 py-2" [ngClass]="getCategoryBadgeClass(productoSeleccionado.categoriaId)">
            <i class="bi bi-tag-fill me-1"></i>
            {{ getCategoryName(productoSeleccionado.categoriaId) }}
          </span>
          <span class="badge rounded-pill bg-secondary px-3 py-2" *ngIf="productoSeleccionado.familiaId">
            <i class="bi bi-diagram-3-fill me-1"></i>
            {{ getFamiliaName(productoSeleccionado.categoriaId, productoSeleccionado.familiaId) }}
          </span>
          <span class="badge rounded-pill px-3 py-2" [ngClass]="productoSeleccionado.esCombinado ? 'bg-warning text-dark' : 'bg-info'">
            <i class="bi" [ngClass]="productoSeleccionado.esCombinado ? 'bi-cup-straw' : 'bi-box'"></i>
            {{ productoSeleccionado.esCombinado ? 'Receta/Combinado' : 'Producto Simple' }}
          </span>
        </div>

        <!-- Información de precios -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card border-0 bg-danger bg-opacity-10 h-100">
              <div class="card-body text-center">
                <i class="bi bi-cash-coin text-danger fs-2 d-block mb-2"></i>
                <h3 class="mb-0 text-danger">{{ productoSeleccionado.costo | currency:'EUR':'symbol':'1.2-2' }}</h3>
                <small class="text-muted">Costo</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 bg-primary h-100">
              <div class="card-body text-center">
                <i class="bi bi-percent text-white fs-2 d-block mb-2"></i>
                <h3 class="mb-0 text-white">{{productoSeleccionado.IVA}}%</h3>
                <small class="text-white opacity-75">IVA</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 bg-success bg-opacity-10 h-100">
              <div class="card-body text-center">
                <i class="bi bi-calculator text-success fs-2 d-block mb-2"></i>
                <h3 class="mb-0 text-success">{{ getPrecioVenta(productoSeleccionado) | currency:'EUR':'symbol':'1.2-2' }}</h3>
                <small class="text-muted">Precio + IVA</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Stock y medidas -->
        <div class="card border-0 bg-light mb-3" *ngIf="!productoSeleccionado.esCombinado">
          <div class="card-body">
            <h6 class="mb-3"><i class="bi bi-boxes me-2 text-primary"></i>Control de Stock</h6>
            <div class="row g-3">
              <div class="col-6">
                <div class="d-flex align-items-center justify-content-between p-3 bg-white rounded">
                  <div>
                    <small class="text-muted d-block">Stock Actual</small>
                    <h4 class="mb-0" [ngClass]="getStockClass(productoSeleccionado)">{{productoSeleccionado.stock}}</h4>
                  </div>
                  <i class="bi bi-box-seam fs-2" [ngClass]="getStockClass(productoSeleccionado)"></i>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center justify-content-between p-3 bg-white rounded">
                  <div>
                    <small class="text-muted d-block">Stock Mínimo</small>
                    <h4 class="mb-0 text-warning">{{productoSeleccionado.stockMinimo}}</h4>
                  </div>
                  <i class="bi bi-exclamation-triangle fs-2 text-warning"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Información adicional -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-info-circle me-2 text-primary"></i>Información del Producto</h6>
                <div class="mb-3">
                  <small class="text-muted d-block">Contenido por unidad</small>
                  <strong class="fs-5 text-info">{{productoSeleccionado.cantidad}} {{productoSeleccionado.unidadMedida}}</strong>
                  <small class="text-muted d-block mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    Cada unidad contiene esta cantidad
                  </small>
                </div>
                <div class="mb-3">
                  <small class="text-muted d-block">Proveedor</small>
                  <div class="d-flex align-items-center mt-1">
                    <i class="bi bi-building me-2 text-primary"></i>
                    <strong>{{ getProveedorName(productoSeleccionado.proveedorId) }}</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>Análisis</h6>
                <div class="mb-3">
                  <small class="text-muted d-block">Margen de ganancia</small>
                  <div class="progress mt-2" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         [style.width.%]="getMargenPorcentaje(productoSeleccionado)"
                         [attr.aria-valuenow]="getMargenPorcentaje(productoSeleccionado)"
                         aria-valuemin="0" aria-valuemax="100">
                      <strong>{{ getMargenPorcentaje(productoSeleccionado) }}%</strong>
                    </div>
                  </div>
                </div>
                <div *ngIf="!productoSeleccionado.esCombinado">
                  <small class="text-muted d-block">Valor en stock</small>
                  <strong class="fs-5 text-success">
                    {{ ((productoSeleccionado.stock || 0) * productoSeleccionado.costo) | currency:'EUR':'symbol':'1.2-2' }}
                  </strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Alerta de stock bajo -->
        <div class="alert alert-warning d-flex align-items-center mt-3"
             *ngIf="!productoSeleccionado.esCombinado && (productoSeleccionado.stock || 0) <= (productoSeleccionado.stockMinimo || 0)">
          <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
          <div>
            <strong>¡Atención!</strong> El stock actual está por debajo o igual al stock mínimo. Considera realizar un pedido.
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-2"></i>Cerrar
        </button>
        <button type="button" class="btn btn-primary" (click)="editarDesdeDetalle()">
          <i class="bi bi-pencil-fill me-2"></i>Editar
        </button>
        <button type="button" class="btn btn-danger" (click)="eliminarDesdeDetalle()">
          <i class="bi bi-trash3-fill me-2"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edición -->
<div class="modal fade" id="productModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <form [formGroup]="productoForm" (ngSubmit)="guardarProducto()">
        <div class="modal-header">
          <h5 class="modal-title">{{ productoForm.get('id')?.value ? 'Editar Producto' : 'Nuevo Producto' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Información básica en dos columnas -->
          <div class="row">
            <!-- Columna izquierda -->
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="nombre" placeholder="Ej: Coca-Cola">
                <div *ngIf="productoForm.get('nombre')?.hasError('productNameExists')" class="text-danger mt-1">
                  Este nombre de producto ya existe.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Descripción <small class="text-muted">(Opcional)</small></label>
                <textarea class="form-control" formControlName="descripcion" placeholder="Descripción del producto" rows="2"></textarea>
              </div>

              <div class="row">
                <div class="col-6 mb-3">
                  <label class="form-label">Costo <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" formControlName="costo" placeholder="0.00" step="0.01">
                </div>
                <div class="col-6 mb-3">
                  <label class="form-label">IVA(%) <span class="text-danger">*</span></label>
                  <select formControlName="IVA" class="form-select">
                    <option selected disabled>Selecciona un IVA</option>
                    <option value="4">4%</option>
                    <option value="10">10%</option>
                    <option value="21">21%</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Categoría <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="categoriaId">
                  <option value="" disabled>Selecciona una categoría</option>
                  <option *ngFor="let categoria of categorias" [value]="categoria.id">{{categoria.nombre}}</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Familia <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="familiaId" [disabled]="familiasDisponibles.length === 0">
                  <option value="" disabled>
                    {{ familiasDisponibles.length === 0 ? 'Primero selecciona una categoría' : 'Selecciona una familia' }}
                  </option>
                  <option *ngFor="let familia of familiasDisponibles" [value]="familia.id">{{familia.nombre}}</option>
                </select>
                <small class="text-muted" *ngIf="familiasDisponibles.length === 0">
                  Las familias se cargarán al seleccionar una categoría
                </small>
              </div>

              <div class="mb-3">
                <label class="form-label">Proveedor <small class="text-muted">(Opcional)</small></label>
                <select class="form-select" formControlName="proveedorId">
                  <option [ngValue]="null">Ninguno</option>
                  <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">{{proveedor.nombre}}</option>
                </select>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" formControlName="esCombinado" id="esCombinadoCheck">
                <label class="form-check-label" for="esCombinadoCheck">
                  Es Receta/Combinado (sin control de stock)
                </label>
              </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-md-6">
              <!-- Información del contenido del producto -->
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-title mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Información del Producto
                  </h6>
                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label">
                        Contenido por Unidad <span class="text-danger">*</span>
                        <i class="bi bi-question-circle text-info ms-1"
                           title="¿Cuánto contiene cada unidad? Ej: 500ml, 1kg, 250g"></i>
                      </label>
                      <input type="number" class="form-control" formControlName="cantidad"
                             placeholder="Ej: 500" step="0.01">
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label">
                        Unidad de Medida <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" formControlName="unidadMedida">
                        <option value="" disabled>Selecciona una unidad</option>
                        <option *ngFor="let unidad of unidadesDisponibles" [value]="unidad">{{unidad}}</option>
                      </select>
                    </div>
                  </div>
                  <div class="alert alert-info py-2 px-3 mb-0">
                    <small>
                      <i class="bi bi-lightbulb me-1"></i>
                      <strong>Ejemplo:</strong> Botella de 500ml → Contenido: 500, Unidad: ml
                    </small>
                  </div>
                </div>
              </div>

              <!-- Control de inventario (solo para productos físicos) -->
              <div class="card bg-light" *ngIf="!productoForm.get('esCombinado')?.value">
                <div class="card-body">
                  <h6 class="card-title mb-3">
                    <i class="bi bi-boxes me-2"></i>
                    Control de Inventario
                  </h6>
                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label">
                        Stock Actual
                        <i class="bi bi-question-circle text-info ms-1"
                           title="¿Cuántas unidades tienes en inventario?"></i>
                      </label>
                      <input type="number" class="form-control" formControlName="stock"
                             placeholder="Ej: 24" min="0">
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label">
                        Stock Mínimo
                        <i class="bi bi-question-circle text-info ms-1"
                           title="¿Cuándo quieres que te avise para reponer?"></i>
                      </label>
                      <input type="number" class="form-control" formControlName="stockMinimo"
                             placeholder="Ej: 5" min="0">
                    </div>
                  </div>
                  <div class="alert alert-warning py-2 px-3 mb-0">
                    <small>
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      El stock se cuenta en unidades completas del producto.
                    </small>
                  </div>
                </div>
              </div>

              <!-- Mensaje para productos combinados -->
              <div class="card bg-warning bg-opacity-10" *ngIf="productoForm.get('esCombinado')?.value">
                <div class="card-body text-center">
                  <i class="bi bi-cup-straw fs-1 text-warning mb-2"></i>
                  <h6 class="text-warning">Producto Receta/Combinado</h6>
                  <small class="text-muted">
                    Este producto no maneja stock físico ya que se prepara con otros ingredientes.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger" [disabled]="productoForm.invalid">
            <i class="bi bi-save me-2"></i>
            {{ productoForm.get('id')?.value ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
