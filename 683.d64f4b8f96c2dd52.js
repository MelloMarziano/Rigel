"use strict";(self.webpackChunkrigel=self.webpackChunkrigel||[]).push([[683],{3683:(se,S,g)=>{g.r(S),g.d(S,{InventarioPageModule:()=>re});var y=g(2432),v=g(9417),b=g(177),P=g(8498),h=g(467),s=g(2418),A=g(8359),R=g(8032),u=g.n(R),e=g(7705),j=g(4441);function x(n,c){if(1&n&&(e.j41(0,"option",46),e.EFF(1),e.k0s()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(1),e.SpI(" ",t.nombre," ")}}function T(n,c){if(1&n&&(e.j41(0,"option",46),e.EFF(1),e.k0s()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(1),e.SpI(" ",t.nombre," ")}}function O(n,c){1&n&&e.nrm(0,"span",47)}function $(n,c){1&n&&e.nrm(0,"i",48)}function M(n,c){1&n&&(e.j41(0,"div",6)(1,"div",49)(2,"div",50)(3,"div",51),e.nrm(4,"i",52),e.k0s(),e.j41(5,"h4",53),e.EFF(6,"No hay inventario para esta fecha"),e.k0s(),e.j41(7,"p",54),e.EFF(8," Selecciona una fecha y crea un nuevo inventario o busca uno existente "),e.k0s()()()())}function w(n,c){1&n&&e.nrm(0,"span",47)}function D(n,c){1&n&&e.nrm(0,"i",86)}function G(n,c){if(1&n){const t=e.RV6();e.j41(0,"div",6)(1,"div",49)(2,"div",78),e.nrm(3,"i",79),e.j41(4,"div",80)(5,"strong"),e.EFF(6,"Inventario en borrador"),e.k0s(),e.EFF(7," - Este inventario no est\xe1 finalizado. Recuerda guardarlo o cancelarlo. "),e.k0s(),e.j41(8,"div",81)(9,"button",82),e.bIt("click",function(){e.eBV(t);const i=e.XpG(2);return e.Njj(i.cancelarInventario())}),e.nrm(10,"i",83),e.EFF(11," Cancelar "),e.k0s(),e.j41(12,"button",84),e.bIt("click",function(){e.eBV(t);const i=e.XpG(2);return e.Njj(i.guardarInventario())}),e.DNE(13,w,1,0,"span",19),e.DNE(14,D,1,0,"i",85),e.EFF(15),e.k0s()()()()()}if(2&n){const t=e.XpG(2);e.R7$(9),e.Y8G("disabled",t.isSaving),e.R7$(3),e.Y8G("disabled",t.isSaving),e.R7$(1),e.Y8G("ngIf",t.isSaving),e.R7$(1),e.Y8G("ngIf",!t.isSaving),e.R7$(1),e.SpI(" ",t.isSaving?"Guardando...":"Finalizar Inventario"," ")}}function N(n,c){if(1&n&&(e.j41(0,"div",87)(1,"div",49)(2,"div",68)(3,"span",88),e.nrm(4,"i",89),e.EFF(5," Inventario Finalizado "),e.k0s(),e.j41(6,"small",39),e.EFF(7),e.nI1(8,"date"),e.k0s()()()()),2&n){const t=e.XpG(2);e.R7$(7),e.SpI(" Finalizado el ",e.i5U(8,1,t.inventarioActual.fechaActualizacion,"dd/MM/yyyy HH:mm")," ")}}function z(n,c){if(1&n){const t=e.RV6();e.j41(0,"button",93),e.bIt("click",function(){const o=e.eBV(t).$implicit,r=e.XpG(3);return e.Njj(r.filtrarPorFamilia(o.id||""))}),e.EFF(1),e.k0s()}if(2&n){const t=c.$implicit,a=e.XpG(3);e.HbH(a.familiaSeleccionada===t.id?"btn-primary":"btn-outline-primary"),e.R7$(1),e.Lme(" ",t.nombre," (",a.getProductosPorFamilia(t.id||"").length,") ")}}function Y(n,c){if(1&n){const t=e.RV6();e.j41(0,"div",6)(1,"div",49)(2,"div",8)(3,"div",9)(4,"div",90)(5,"h6",91),e.EFF(6,"Filtrar por familia:"),e.k0s(),e.j41(7,"div",92)(8,"button",93),e.bIt("click",function(){e.eBV(t);const i=e.XpG(2);return e.Njj(i.filtrarPorFamilia(""))}),e.EFF(9),e.k0s(),e.DNE(10,z,2,4,"button",94),e.k0s()()()()()()}if(2&n){const t=e.XpG(2);e.R7$(8),e.HbH(""===t.familiaSeleccionada?"btn-primary":"btn-outline-primary"),e.R7$(1),e.SpI(" Todas (",t.inventarioActual.productos.length,") "),e.R7$(1),e.Y8G("ngForOf",t.familiasDisponibles)}}function B(n,c){1&n&&(e.j41(0,"span",95),e.EFF(1,"Borrador"),e.k0s())}function U(n,c){1&n&&(e.j41(0,"span",96),e.EFF(1,"Finalizado"),e.k0s())}function V(n,c){if(1&n&&(e.j41(0,"span",97),e.EFF(1),e.k0s()),2&n){const t=e.XpG(2);e.R7$(1),e.JRh(t.getNombreFamiliaSeleccionada())}}function X(n,c){1&n&&e.nrm(0,"span",47)}function J(n,c){1&n&&e.nrm(0,"i",100)}function H(n,c){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"button",82),e.bIt("click",function(){e.eBV(t);const i=e.XpG(2);return e.Njj(i.cancelarInventario())}),e.nrm(2,"i",83),e.EFF(3," Cancelar "),e.k0s(),e.j41(4,"button",98),e.bIt("click",function(){e.eBV(t);const i=e.XpG(2);return e.Njj(i.guardarInventario())}),e.DNE(5,X,1,0,"span",19),e.DNE(6,J,1,0,"i",99),e.EFF(7),e.k0s()()}if(2&n){const t=e.XpG(2);e.R7$(1),e.Y8G("disabled",t.isSaving),e.R7$(3),e.Y8G("disabled",t.isSaving),e.R7$(1),e.Y8G("ngIf",t.isSaving),e.R7$(1),e.Y8G("ngIf",!t.isSaving),e.R7$(1),e.SpI(" ",t.isSaving?"Finalizando...":"Finalizar Inventario"," ")}}function L(n,c){1&n&&(e.j41(0,"div")(1,"span",58),e.nrm(2,"i",101),e.EFF(3," Inventario finalizado - Solo lectura "),e.k0s()())}function Z(n,c){if(1&n&&(e.j41(0,"small"),e.EFF(1),e.nI1(2,"number"),e.k0s()),2&n){const t=e.XpG().$implicit;e.HbH(t.diferencia>0?"text-success":"text-danger"),e.R7$(1),e.Lme(" ",t.diferencia>0?"+":"","",e.i5U(2,4,t.diferencia,"1.1-1")," ")}}function K(n,c){if(1&n){const t=e.RV6();e.j41(0,"tr")(1,"td")(2,"div")(3,"strong"),e.EFF(4),e.k0s(),e.nrm(5,"br"),e.j41(6,"small",39),e.EFF(7),e.k0s()()(),e.j41(8,"td")(9,"span",102),e.EFF(10),e.k0s()(),e.j41(11,"td"),e.EFF(12),e.k0s(),e.j41(13,"td")(14,"span"),e.EFF(15),e.nI1(16,"number"),e.k0s()(),e.j41(17,"td"),e.EFF(18),e.nI1(19,"currency"),e.k0s(),e.j41(20,"td")(21,"input",103),e.bIt("ngModelChange",function(i){const r=e.eBV(t).$implicit;return e.Njj(r.stockContado=i)})("ngModelChange",function(){const o=e.eBV(t).$implicit,r=e.XpG(2);return e.Njj(r.calcularValorTotal(o))}),e.k0s(),e.DNE(22,Z,3,7,"small",104),e.k0s(),e.j41(23,"td")(24,"strong"),e.EFF(25),e.nI1(26,"currency"),e.k0s()()()}if(2&n){const t=c.$implicit,a=e.XpG(2);e.R7$(4),e.JRh(t.nombre),e.R7$(3),e.JRh(t.unidadMedida),e.R7$(3),e.JRh(t.categoria),e.R7$(2),e.JRh(t.proveedor),e.R7$(2),e.HbH(a.getStockClass(t.stockActual)),e.R7$(1),e.SpI(" ",e.i5U(16,16,t.stockActual,"1.1-1")," "),e.R7$(3),e.SpI(" ",e.ii3(19,19,t.costoUnitario,"EUR","symbol","1.2-2")," "),e.R7$(3),e.AVh("is-invalid",0!==t.diferencia),e.Y8G("ngModel",t.stockContado)("disabled","finalizado"===a.inventarioActual.estado),e.R7$(1),e.Y8G("ngIf",0!==t.diferencia),e.R7$(2),e.HbH(0!==t.diferencia?"text-warning":"text-success"),e.R7$(1),e.SpI(" ",e.ii3(26,24,t.valorTotal,"EUR","symbol","1.0-0")," ")}}function Q(n,c){if(1&n&&(e.j41(0,"div"),e.DNE(1,G,16,5,"div",21),e.DNE(2,N,9,4,"div",55),e.j41(3,"div",6)(4,"div",56)(5,"div",8)(6,"div",36)(7,"div",57)(8,"span",58),e.EFF(9,"Inversi\xf3n Total"),e.k0s(),e.nrm(10,"i",59),e.k0s(),e.j41(11,"h3",60),e.EFF(12),e.nI1(13,"currency"),e.k0s()()()(),e.j41(14,"div",56)(15,"div",8)(16,"div",36)(17,"div",57)(18,"span",58),e.EFF(19,"Total Productos"),e.k0s(),e.nrm(20,"i",61),e.k0s(),e.j41(21,"h3",62),e.EFF(22),e.k0s()()()(),e.j41(23,"div",56)(24,"div",8)(25,"div",36)(26,"div",57)(27,"span",58),e.EFF(28,"Total Unidades"),e.k0s(),e.nrm(29,"i",63),e.k0s(),e.j41(30,"h3",64),e.EFF(31),e.nI1(32,"number"),e.k0s()()()(),e.j41(33,"div",56)(34,"div",8)(35,"div",36)(36,"div",57)(37,"span",58),e.EFF(38,"Costo Promedio"),e.k0s(),e.nrm(39,"i",65),e.k0s(),e.j41(40,"h3",66),e.EFF(41),e.nI1(42,"currency"),e.k0s()()()()(),e.DNE(43,Y,11,4,"div",21),e.j41(44,"div",6)(45,"div",49)(46,"div",8)(47,"div",67)(48,"div",68)(49,"h5",69),e.EFF(50),e.DNE(51,B,2,0,"span",70),e.DNE(52,U,2,0,"span",71),e.DNE(53,V,2,1,"span",72),e.k0s(),e.DNE(54,H,8,5,"div",22),e.DNE(55,L,4,0,"div",22),e.k0s()(),e.j41(56,"div",73)(57,"div",74)(58,"table",75)(59,"thead",76)(60,"tr")(61,"th"),e.EFF(62,"PRODUCTO"),e.k0s(),e.j41(63,"th"),e.EFF(64,"CATEGOR\xcdA"),e.k0s(),e.j41(65,"th"),e.EFF(66,"PROVEEDOR"),e.k0s(),e.j41(67,"th"),e.EFF(68,"STOCK ACTUAL"),e.k0s(),e.j41(69,"th"),e.EFF(70,"COSTO UNITARIO"),e.k0s(),e.j41(71,"th"),e.EFF(72,"STOCK CONTADO"),e.k0s(),e.j41(73,"th"),e.EFF(74,"VALOR TOTAL"),e.k0s()()(),e.j41(75,"tbody"),e.DNE(76,K,27,29,"tr",77),e.k0s()()()()()()()()),2&n){const t=e.XpG();e.R7$(1),e.Y8G("ngIf","borrador"===t.inventarioActual.estado),e.R7$(1),e.Y8G("ngIf","finalizado"===t.inventarioActual.estado),e.R7$(10),e.SpI(" ",e.ii3(13,16,t.inventarioActual.inversionTotal,"EUR","symbol","1.0-0")," "),e.R7$(10),e.SpI(" ",t.inventarioActual.totalProductos," "),e.R7$(9),e.SpI(" ",e.i5U(32,21,t.inventarioActual.totalUnidades,"1.1-1")," "),e.R7$(10),e.SpI(" ",e.ii3(42,24,t.inventarioActual.costoPromedio,"EUR","symbol","1.0-0")," "),e.R7$(2),e.Y8G("ngIf",t.familiasDisponibles.length>0),e.R7$(7),e.Lme(" Productos del Inventario (",t.productosFiltrados.length," de ",t.inventarioActual.productos.length,") "),e.R7$(1),e.Y8G("ngIf","borrador"===t.inventarioActual.estado),e.R7$(1),e.Y8G("ngIf","finalizado"===t.inventarioActual.estado),e.R7$(1),e.Y8G("ngIf",t.familiaSeleccionada),e.R7$(1),e.Y8G("ngIf","borrador"===t.inventarioActual.estado),e.R7$(1),e.Y8G("ngIf","finalizado"===t.inventarioActual.estado),e.R7$(21),e.Y8G("ngForOf",t.productosFiltrados)("ngForTrackBy",t.trackByProducto)}}function W(n,c){1&n&&(e.j41(0,"div",6)(1,"div",49)(2,"div",50)(3,"div",105)(4,"span",106),e.EFF(5,"Cargando..."),e.k0s()(),e.j41(6,"h4",53),e.EFF(7,"Creando inventario..."),e.k0s(),e.j41(8,"p",39),e.EFF(9," Cargando productos y preparando el inventario para la fecha seleccionada "),e.k0s()()()())}function q(n,c){if(1&n&&(e.j41(0,"span",118),e.EFF(1),e.k0s()),2&n){const t=e.XpG().$implicit;e.R7$(1),e.SpI(" \u2022 ",t.familias.length," familias ")}}function ee(n,c){if(1&n&&(e.j41(0,"div",112)(1,"div",113)(2,"div",114),e.nrm(3,"i",115),e.k0s(),e.j41(4,"div")(5,"small",116),e.EFF(6),e.k0s(),e.nrm(7,"br"),e.j41(8,"small",39),e.EFF(9),e.k0s(),e.DNE(10,q,2,1,"span",117),e.k0s()()()),2&n){const t=c.$implicit;e.R7$(2),e.xc7("background-color",t.colorFondo),e.R7$(1),e.HbH("bi "+t.icono+" text-white"),e.R7$(3),e.JRh(t.nombre),e.R7$(3),e.SpI("",t.productos," productos"),e.R7$(1),e.Y8G("ngIf",t.familias&&t.familias.length>0)}}function te(n,c){if(1&n&&(e.j41(0,"div",49)(1,"div",107)(2,"h6",108),e.nrm(3,"i",109),e.EFF(4," \xc1rea seleccionada: "),e.j41(5,"strong"),e.EFF(6),e.nI1(7,"titlecase"),e.k0s()(),e.j41(8,"p",108),e.EFF(9," Se incluir\xe1n "),e.j41(10,"strong"),e.EFF(11),e.k0s(),e.EFF(12," categor\xedas con "),e.j41(13,"strong"),e.EFF(14),e.k0s(),e.EFF(15," productos en el inventario. "),e.k0s(),e.j41(16,"div",110)(17,"h6",108),e.EFF(18,"Categor\xedas incluidas:"),e.k0s(),e.j41(19,"div",1),e.DNE(20,ee,11,7,"div",111),e.k0s()()()()),2&n){const t=e.XpG();e.R7$(6),e.JRh(e.bMT(7,4,t.areaSeleccionada)),e.R7$(5),e.JRh(t.getCategoriasArea(t.areaSeleccionada).length),e.R7$(3),e.JRh(t.getTotalProductosArea()),e.R7$(6),e.Y8G("ngForOf",t.getCategoriasArea(t.areaSeleccionada))}}function ie(n,c){1&n&&e.nrm(0,"span",47)}function ae(n,c){1&n&&e.nrm(0,"i",119)}const ne=[{path:"",component:(()=>{class n{constructor(t,a){this.firestore=t,this.authService=a,this.isLoading=!1,this.isCreatingInventory=!1,this.isSaving=!1,this.inventarioActual=null,this.productos=[],this.categorias=[],this.proveedores=[],this.fechaSeleccionada=new Date,this.fechaFiltro=new v.MJ((new Date).toISOString().split("T")[0]),this.categoriaFiltro=new v.MJ(""),this.proveedorFiltro=new v.MJ(""),this.areaSeleccionada="",this.categoriasSeleccionadas=[],this.familiasDisponibles=[],this.familiaSeleccionada="",this.productosFiltrados=[],this.subscriptions=new A.yU}convertirFecha(t){if(t){if(t instanceof Date)return t;if("object"==typeof t&&"toDate"in t)return t.toDate();if("string"==typeof t)return new Date(t)}}limpiarObjetoParaFirebase(t){const a={};for(const[i,o]of Object.entries(t))null!=o&&(a[i]=o);return a}ngOnInit(){console.log("Inicializando p\xe1gina de inventario...");const t=this.authService.getCurrentUser();if(!t)return console.error("Usuario no autenticado"),void u().fire("Error","Usuario no autenticado","error");console.log("Usuario autenticado:",t.nombre),this.cargarDatosIniciales(),this.setupFiltros(),console.log("P\xe1gina de inventario inicializada correctamente")}ngOnDestroy(){this.subscriptions.unsubscribe()}setupFiltros(){this.subscriptions.add(this.fechaFiltro.valueChanges.subscribe(t=>{if(t)try{this.fechaSeleccionada=new Date(t),console.log("Fecha seleccionada:",this.fechaSeleccionada)}catch(a){console.error("Error procesando fecha:",a),this.fechaSeleccionada=new Date}}))}cargarDatosIniciales(){var t=this;return(0,h.A)(function*(){try{console.log("Cargando datos iniciales...");const a=(0,s.rJ)(t.firestore,"productos");t.subscriptions.add((0,s.xs)(a,{idField:"id"}).subscribe({next:r=>{t.productos=r.filter(f=>!f.esCombinado),console.log("Productos cargados:",t.productos.length)},error:r=>{console.error("Error cargando productos:",r)}}));const i=(0,s.rJ)(t.firestore,"categorias");t.subscriptions.add((0,s.xs)(i,{idField:"id"}).subscribe({next:r=>{t.categorias=r,console.log("Categor\xedas cargadas:",t.categorias.length)},error:r=>{console.error("Error cargando categor\xedas:",r)}}));const o=(0,s.rJ)(t.firestore,"proveedores");t.subscriptions.add((0,s.xs)(o,{idField:"id"}).subscribe({next:r=>{t.proveedores=r,console.log("Proveedores cargados:",t.proveedores.length)},error:r=>{console.error("Error cargando proveedores:",r)}}))}catch(a){console.error("Error cargando datos iniciales:",a),u().fire("Error","Error al cargar los datos iniciales","error")}})()}buscarInventario(){var t=this;return(0,h.A)(function*(){t.isLoading=!0;try{const a=t.fechaSeleccionada.toISOString().split("T")[0];console.log("Buscando inventario para fecha:",a);const i=(0,s.rJ)(t.firestore,"inventarios"),o=(0,s.P)(i,(0,s._M)("fecha","==",a));console.log("Ejecutando consulta...");const r=yield(0,s.GG)(o);if(console.log("Documentos encontrados:",r.size),r.empty)t.inventarioActual=null;else{const f=r.docs.filter(m=>!m.data().eliminado);if(f.length>0){const m=f[0];t.inventarioActual={id:m.id,...m.data()},t.inventarioActual.fecha=t.convertirFecha(t.inventarioActual.fecha)||t.inventarioActual.fecha,t.inventarioActual.fechaActualizacion=t.convertirFecha(t.inventarioActual.fechaActualizacion),t.inventarioActual.fechaCreacion=t.convertirFecha(t.inventarioActual.fechaCreacion)}else t.inventarioActual=null}t.inventarioActual&&(t.configurarFamiliasDisponibles(),t.aplicarFiltroFamilia())}catch(a){console.error("Error buscando inventario:",a),t.inventarioActual=null}finally{t.isLoading=!1}})()}crearNuevoInventario(){var t=this;return(0,h.A)(function*(){if(!t.inventarioActual||(yield u().fire({title:"\xbfCrear nuevo inventario?",text:"Ya existe un inventario para esta fecha. \xbfDeseas reemplazarlo?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:"S\xed, crear nuevo",cancelButtonText:"Cancelar"})).isConfirmed){t.isCreatingInventory=!0;try{let a=[...t.productos];const i=t.categoriaFiltro.value,o=t.proveedorFiltro.value;i&&(a=a.filter(l=>l.categoriaId===i)),o&&(a=a.filter(l=>l.proveedorId===o));const r=a.map(l=>{const p=t.categorias.find(E=>E.id===l.categoriaId),ce=t.proveedores.find(E=>E.id===l.proveedorId);return{productoId:l.id,nombre:l.nombre,categoria:p?.nombre||"Sin categor\xeda",proveedor:ce?.nombre||"Sin proveedor",stockActual:l.stock||0,stockContado:l.stock||0,costoUnitario:l.costo,valorTotal:(l.stock||0)*l.costo,unidadMedida:l.unidadMedida,diferencia:0}}),f=r.reduce((l,p)=>l+p.valorTotal,0),m=r.length,_=r.reduce((l,p)=>l+p.stockContado,0),I=_>0?f/_:0,C={fecha:t.fechaSeleccionada.toISOString().split("T")[0],categoriaId:i||void 0,proveedorId:o||void 0,productos:r,inversionTotal:f,totalProductos:m,totalUnidades:_,costoPromedio:I,fechaCreacion:(0,s.O5)(),usuarioId:t.authService.getCurrentUser()?.id,estado:"borrador"},k=t.limpiarObjetoParaFirebase(C),d=(0,s.rJ)(t.firestore,"inventarios"),F=yield(0,s.gS)(d,k);t.inventarioActual={id:F.id,fecha:t.fechaSeleccionada,categoriaId:i||void 0,proveedorId:o||void 0,productos:r,inversionTotal:f,totalProductos:m,totalUnidades:_,costoPromedio:I,fechaCreacion:new Date,usuarioId:t.authService.getCurrentUser()?.id,estado:"borrador"},u().fire("\xa1Creado!","Inventario creado como borrador. Puedes editarlo y luego finalizarlo.","success")}catch(a){console.error("Error creando inventario:",a),u().fire("Error","Error al crear el inventario","error")}finally{t.isCreatingInventory=!1}}})()}recalcularTotales(){this.inventarioActual&&(this.inventarioActual.inversionTotal=this.inventarioActual.productos.reduce((t,a)=>t+a.valorTotal,0),this.inventarioActual.totalUnidades=this.inventarioActual.productos.reduce((t,a)=>t+a.stockContado,0),this.inventarioActual.costoPromedio=this.inventarioActual.totalUnidades>0?this.inventarioActual.inversionTotal/this.inventarioActual.totalUnidades:0)}guardarInventario(){var t=this;return(0,h.A)(function*(){if(t.inventarioActual&&("borrador"!==t.inventarioActual.estado||(yield u().fire({title:"\xbfFinalizar inventario?",text:"Una vez finalizado, no podr\xe1s editarlo. \xbfEst\xe1s seguro?",icon:"question",showCancelButton:!0,confirmButtonColor:"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:"S\xed, finalizar",cancelButtonText:"Cancelar"})).isConfirmed)){t.isSaving=!0;try{const a={...t.inventarioActual,fecha:t.fechaSeleccionada.toISOString().split("T")[0],fechaActualizacion:(0,s.O5)(),estado:"finalizado"},i=t.limpiarObjetoParaFirebase(a);if(t.inventarioActual.id){const o=(0,s.H9)(t.firestore,"inventarios",t.inventarioActual.id);yield(0,s.mZ)(o,i),t.inventarioActual.estado="finalizado",t.inventarioActual.fechaActualizacion=new Date}else{const o=(0,s.rJ)(t.firestore,"inventarios"),r=yield(0,s.gS)(o,i);t.inventarioActual.id=r.id,t.inventarioActual.estado="finalizado"}u().fire("\xa1Finalizado!","Inventario finalizado exitosamente","success")}catch(a){console.error("Error finalizando inventario:",a),u().fire("Error","Error al finalizar el inventario","error")}finally{t.isSaving=!1}}})()}getStockClass(t){return t<=0?"text-danger fw-bold":t<=5?"text-warning fw-bold":"text-success fw-bold"}trackByProducto(t,a){return a.productoId}cancelarInventario(){var t=this;return(0,h.A)(function*(){if((yield u().fire({title:"\xbfCancelar inventario?",text:"Se eliminar\xe1 el inventario en borrador. Esta acci\xf3n no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:"S\xed, cancelar",cancelButtonText:"No cancelar"})).isConfirmed){t.isSaving=!0;try{if(t.inventarioActual?.id){const i=(0,s.H9)(t.firestore,"inventarios",t.inventarioActual.id);yield(0,s.mZ)(i,{eliminado:!0,fechaEliminacion:(0,s.O5)()})}t.inventarioActual=null,u().fire("\xa1Cancelado!","El inventario ha sido cancelado","success")}catch(i){console.error("Error cancelando inventario:",i),u().fire("Error","Error al cancelar el inventario","error")}finally{t.isSaving=!1}}})()}calcularValorTotal(t){"finalizado"!==this.inventarioActual?.estado&&(t.diferencia=t.stockContado-t.stockActual,t.valorTotal=t.stockContado*t.costoUnitario,this.recalcularTotales(),"borrador"===this.inventarioActual?.estado&&this.autoGuardarBorrador())}autoGuardarBorrador(){this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{this.guardarBorrador()},2e3)}guardarBorrador(){var t=this;return(0,h.A)(function*(){if(t.inventarioActual?.id&&"borrador"===t.inventarioActual.estado)try{const a=(0,s.H9)(t.firestore,"inventarios",t.inventarioActual.id);yield(0,s.mZ)(a,{productos:t.inventarioActual.productos,inversionTotal:t.inventarioActual.inversionTotal,totalUnidades:t.inventarioActual.totalUnidades,costoPromedio:t.inventarioActual.costoPromedio,fechaActualizacion:(0,s.O5)()})}catch(a){console.error("Error en auto-guardado:",a)}})()}abrirModalNuevoInventario(){this.areaSeleccionada="",this.categoriasSeleccionadas=[];const t=document.getElementById("modalNuevoInventario");t&&(this.modal=new bootstrap.Modal(t),this.modal.show())}cerrarModalNuevoInventario(){this.modal&&this.modal.hide(),this.areaSeleccionada="",this.categoriasSeleccionadas=[]}seleccionarArea(t){this.areaSeleccionada=t;const a=this.getCategoriasArea(t);this.categoriasSeleccionadas=a.map(i=>i.id||"").filter(i=>i)}getCategoriasArea(t){return this.categorias.filter("barra"===t?a=>a.familias?.some(i=>["whisky","vinos","refrescos","cervezas","bebidas"].some(o=>i.nombre.toLowerCase().includes(o))):a=>a.familias?.some(i=>["entrantes","platos","postres","comida","ingredientes"].some(o=>i.nombre.toLowerCase().includes(o))))}toggleCategoria(t){const a=this.categoriasSeleccionadas.indexOf(t);a>-1?this.categoriasSeleccionadas.splice(a,1):this.categoriasSeleccionadas.push(t)}seleccionarTodasCategorias(){const t=this.getCategoriasArea(this.areaSeleccionada);this.categoriasSeleccionadas=t.map(a=>a.id||"").filter(a=>a)}deseleccionarTodasCategorias(){this.categoriasSeleccionadas=[]}getTotalProductosSeleccionados(){return this.productos.filter(t=>this.categoriasSeleccionadas.includes(t.categoriaId)).length}getTotalProductosArea(){if(!this.areaSeleccionada)return 0;const a=this.getCategoriasArea(this.areaSeleccionada).map(i=>i.id||"").filter(i=>i);return this.productos.filter(i=>a.includes(i.categoriaId)&&!i.esCombinado).length}crearInventarioConSeleccion(){var t=this;return(0,h.A)(function*(){if(t.areaSeleccionada){if(0===t.categoriasSeleccionadas.length){const a=t.getCategoriasArea(t.areaSeleccionada);t.categoriasSeleccionadas=a.map(i=>i.id||"").filter(i=>i)}if(!t.inventarioActual||(yield u().fire({title:"\xbfCrear nuevo inventario?",text:"Ya existe un inventario para esta fecha. \xbfDeseas reemplazarlo?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:"S\xed, crear nuevo",cancelButtonText:"Cancelar"})).isConfirmed){t.isCreatingInventory=!0;try{const i=t.productos.filter(d=>t.categoriasSeleccionadas.includes(d.categoriaId)&&!d.esCombinado).map(d=>{const F=t.categorias.find(p=>p.id===d.categoriaId),l=t.proveedores.find(p=>p.id===d.proveedorId);return{productoId:d.id,nombre:d.nombre,categoria:F?.nombre||"Sin categor\xeda",proveedor:l?.nombre||"Sin proveedor",stockActual:d.stock||0,stockContado:d.stock||0,costoUnitario:d.costo,valorTotal:(d.stock||0)*d.costo,unidadMedida:d.unidadMedida,diferencia:0,familiaId:d.familiaId}}),o=i.reduce((d,F)=>d+F.valorTotal,0),r=i.length,f=i.reduce((d,F)=>d+F.stockContado,0),m=f>0?o/f:0,_={fecha:t.fechaSeleccionada.toISOString().split("T")[0],area:t.areaSeleccionada,categoriasSeleccionadas:t.categoriasSeleccionadas,productos:i,inversionTotal:o,totalProductos:r,totalUnidades:f,costoPromedio:m,fechaCreacion:(0,s.O5)(),usuarioId:t.authService.getCurrentUser()?.id,estado:"borrador"},I=t.limpiarObjetoParaFirebase(_),C=(0,s.rJ)(t.firestore,"inventarios"),k=yield(0,s.gS)(C,I);t.inventarioActual={id:k.id,fecha:t.fechaSeleccionada,area:t.areaSeleccionada,categoriasSeleccionadas:t.categoriasSeleccionadas,productos:i,inversionTotal:o,totalProductos:r,totalUnidades:f,costoPromedio:m,fechaCreacion:new Date,usuarioId:t.authService.getCurrentUser()?.id,estado:"borrador"},t.configurarFamiliasDisponibles(),t.aplicarFiltroFamilia(),t.cerrarModalNuevoInventario(),u().fire("\xa1Creado!",`Inventario de ${t.areaSeleccionada} creado con ${r} productos. Puedes editarlo y luego finalizarlo.`,"success")}catch(a){console.error("Error creando inventario:",a),u().fire("Error","Error al crear el inventario","error")}finally{t.isCreatingInventory=!1}}}else u().fire("Error","Selecciona un \xe1rea para el inventario","error")})()}configurarFamiliasDisponibles(){if(!this.inventarioActual)return;const t=new Set,a=new Map;this.inventarioActual.productos.forEach(i=>{const o=this.categorias.find(r=>r.nombre===i.categoria);o?.familias&&o.familias.forEach(r=>{r.id&&!t.has(r.id)&&(t.add(r.id),a.set(r.id,r))})}),this.familiasDisponibles=Array.from(a.values())}filtrarPorFamilia(t){this.familiaSeleccionada=t,this.aplicarFiltroFamilia()}aplicarFiltroFamilia(){this.inventarioActual&&(this.productosFiltrados=this.familiaSeleccionada?this.inventarioActual.productos.filter(t=>this.productos.find(i=>i.id===t.productoId)?.familiaId===this.familiaSeleccionada):[...this.inventarioActual.productos])}getProductosPorFamilia(t){return this.inventarioActual?this.inventarioActual.productos.filter(a=>this.productos.find(o=>o.id===a.productoId)?.familiaId===t):[]}getNombreFamiliaSeleccionada(){return this.familiasDisponibles.find(a=>a.id===this.familiaSeleccionada)?.nombre||""}getFamiliasNombres(t){return t&&0!==t.length?t.map(a=>a.nombre).join(", "):""}static{this.\u0275fac=function(a){return new(a||n)(e.rXU(s._7),e.rXU(j.u))}}static{this.\u0275cmp=e.VBU({type:n,selectors:[["app-inventario-page"]],decls:86,vars:28,consts:[[1,"container-fluid"],[1,"row"],[1,"col-8"],[1,"col","text-end"],[1,"btn","btn-danger",3,"disabled","click"],[1,"bi","bi-plus-lg","me-2"],[1,"row","mt-4"],[1,"col"],[1,"card","border-0","shadow-sm"],[1,"card-body"],[1,"row","align-items-center"],[1,"col-12","col-md-3","mb-2","mb-md-0"],[1,"form-label","small","text-muted"],["type","date",1,"form-control",3,"formControl","value"],[1,"form-select",3,"formControl"],["value",""],[3,"value",4,"ngFor","ngForOf"],[1,"col-12","col-md-3","text-end","mt-4"],[1,"btn","btn-outline-danger","w-100",3,"disabled","click"],["class","spinner-border spinner-border-sm me-2",4,"ngIf"],["class","bi bi-search me-2",4,"ngIf"],["class","row mt-4",4,"ngIf"],[4,"ngIf"],["id","modalNuevoInventario","tabindex","-1","data-bs-backdrop","static",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],[1,"bi","bi-clipboard-check","me-2"],["type","button",1,"btn-close",3,"click"],[1,"modal-body"],[1,"col-12","mb-4"],[1,"mb-3"],[1,"bi","bi-geo-alt","me-2"],[1,"col-md-6","mb-3"],[1,"card","h-100","cursor-pointer","area-card",3,"click"],[1,"card-body","text-center"],[1,"bi","bi-cup","fs-1","text-primary","mb-3"],[1,"text-muted","mb-0"],[1,"text-muted"],[1,"bi","bi-egg-fried","fs-1","text-success","mb-3"],["class","col-12",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-danger",3,"disabled","click"],["class","bi bi-plus me-2",4,"ngIf"],[3,"value"],[1,"spinner-border","spinner-border-sm","me-2"],[1,"bi","bi-search","me-2"],[1,"col-12"],[1,"text-center","py-5"],[1,"mb-4"],[1,"bi","bi-archive","text-muted",2,"font-size","4rem"],[1,"text-muted","mb-3"],[1,"text-muted","mb-4"],["class","row mt-3",4,"ngIf"],[1,"col-12","col-md-3","mb-3"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"text-muted","small"],[1,"bi","bi-currency-euro","text-danger"],[1,"text-danger","fw-bold","mb-0"],[1,"bi","bi-box","text-info"],[1,"text-info","fw-bold","mb-0"],[1,"bi","bi-graph-up","text-success"],[1,"text-success","fw-bold","mb-0"],[1,"bi","bi-calculator","text-warning"],[1,"text-warning","fw-bold","mb-0"],[1,"card-header","bg-white","border-0","py-3"],[1,"d-flex","justify-content-between","align-items-center"],[1,"mb-0"],["class","badge bg-warning ms-2",4,"ngIf"],["class","badge bg-success ms-2",4,"ngIf"],["class","badge bg-info ms-2",4,"ngIf"],[1,"card-body","p-0"],[1,"table-responsive"],[1,"table","table-hover","mb-0"],[1,"table-light"],[4,"ngFor","ngForOf","ngForTrackBy"],["role","alert",1,"alert","alert-warning","d-flex","align-items-center"],[1,"bi","bi-exclamation-triangle-fill","me-2"],[1,"flex-grow-1"],[1,"ms-3"],[1,"btn","btn-outline-secondary","btn-sm","me-2",3,"disabled","click"],[1,"bi","bi-x-lg","me-1"],[1,"btn","btn-warning","btn-sm",3,"disabled","click"],["class","bi bi-save me-1",4,"ngIf"],[1,"bi","bi-save","me-1"],[1,"row","mt-3"],[1,"badge","bg-success","fs-6"],[1,"bi","bi-check-circle","me-1"],[1,"d-flex","align-items-center","mb-3"],[1,"mb-0","me-3"],["role","group",1,"btn-group"],["type","button",1,"btn","btn-sm",3,"click"],["type","button","class","btn btn-sm",3,"class","click",4,"ngFor","ngForOf"],[1,"badge","bg-warning","ms-2"],[1,"badge","bg-success","ms-2"],[1,"badge","bg-info","ms-2"],[1,"btn","btn-danger","btn-sm",3,"disabled","click"],["class","bi bi-save me-2",4,"ngIf"],[1,"bi","bi-save","me-2"],[1,"bi","bi-lock","me-1"],[1,"badge","bg-primary","rounded-pill"],["type","number","step","0.1","min","0",1,"form-control","form-control-sm",2,"width","100px",3,"ngModel","disabled","ngModelChange"],[3,"class",4,"ngIf"],["role","status",1,"spinner-border","text-danger","mb-3"],[1,"visually-hidden"],[1,"alert","alert-success"],[1,"mb-2"],[1,"bi","bi-check-circle","me-2"],[1,"mt-3"],["class","col-md-6 mb-2",4,"ngFor","ngForOf"],[1,"col-md-6","mb-2"],[1,"d-flex","align-items-center"],[1,"rounded-circle","p-1","me-2",2,"width","24px","height","24px"],[2,"font-size","0.7rem"],[1,"fw-bold"],["class","text-info",4,"ngIf"],[1,"text-info"],[1,"bi","bi-plus","me-2"]],template:function(a,i){1&a&&(e.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3"),e.EFF(4,"Gesti\xf3n de Inventario"),e.k0s(),e.j41(5,"span"),e.EFF(6,"Control y conteo de stock por fechas"),e.k0s()(),e.j41(7,"div",3)(8,"button",4),e.bIt("click",function(){return i.abrirModalNuevoInventario()}),e.nrm(9,"i",5),e.EFF(10," Nuevo Inventario "),e.k0s()()(),e.j41(11,"div",6)(12,"div",7)(13,"div",8)(14,"div",9)(15,"div",10)(16,"div",11)(17,"label",12),e.EFF(18,"Fecha del Inventario"),e.k0s(),e.nrm(19,"input",13),e.nI1(20,"date"),e.k0s(),e.j41(21,"div",11)(22,"label",12),e.EFF(23,"Categor\xeda"),e.k0s(),e.j41(24,"select",14)(25,"option",15),e.EFF(26,"Todas las categor\xedas"),e.k0s(),e.DNE(27,x,2,2,"option",16),e.k0s()(),e.j41(28,"div",11)(29,"label",12),e.EFF(30,"Proveedor"),e.k0s(),e.j41(31,"select",14)(32,"option",15),e.EFF(33,"Todos los proveedores"),e.k0s(),e.DNE(34,T,2,2,"option",16),e.k0s()(),e.j41(35,"div",17)(36,"button",18),e.bIt("click",function(){return i.buscarInventario()}),e.DNE(37,O,1,0,"span",19),e.DNE(38,$,1,0,"i",20),e.EFF(39),e.k0s()()()()()()(),e.DNE(40,M,9,0,"div",21),e.DNE(41,Q,77,29,"div",22),e.DNE(42,W,10,0,"div",21),e.k0s(),e.j41(43,"div",23)(44,"div",24)(45,"div",25)(46,"div",26)(47,"h5",27),e.nrm(48,"i",28),e.EFF(49," Crear Nuevo Inventario "),e.k0s(),e.j41(50,"button",29),e.bIt("click",function(){return i.cerrarModalNuevoInventario()}),e.k0s()(),e.j41(51,"div",30)(52,"div",1)(53,"div",31)(54,"h6",32),e.nrm(55,"i",33),e.EFF(56," Selecciona el \xe1rea del inventario: "),e.k0s(),e.j41(57,"div",1)(58,"div",34)(59,"div",35),e.bIt("click",function(){return i.seleccionarArea("barra")}),e.j41(60,"div",36),e.nrm(61,"i",37),e.j41(62,"h5"),e.EFF(63,"Barra"),e.k0s(),e.j41(64,"p",38),e.EFF(65,"Bebidas, c\xf3cteles y productos de bar"),e.k0s(),e.j41(66,"small",39),e.EFF(67),e.k0s()()()(),e.j41(68,"div",34)(69,"div",35),e.bIt("click",function(){return i.seleccionarArea("cocina")}),e.j41(70,"div",36),e.nrm(71,"i",40),e.j41(72,"h5"),e.EFF(73,"Cocina"),e.k0s(),e.j41(74,"p",38),e.EFF(75,"Alimentos, ingredientes y productos de cocina"),e.k0s(),e.j41(76,"small",39),e.EFF(77),e.k0s()()()()()(),e.DNE(78,te,21,6,"div",41),e.k0s()(),e.j41(79,"div",42)(80,"button",43),e.bIt("click",function(){return i.cerrarModalNuevoInventario()}),e.EFF(81," Cancelar "),e.k0s(),e.j41(82,"button",44),e.bIt("click",function(){return i.crearInventarioConSeleccion()}),e.DNE(83,ie,1,0,"span",19),e.DNE(84,ae,1,0,"i",45),e.EFF(85),e.k0s()()()()()),2&a&&(e.R7$(8),e.Y8G("disabled",i.isLoading),e.R7$(11),e.Y8G("formControl",i.fechaFiltro)("value",e.i5U(20,25,i.fechaSeleccionada,"yyyy-MM-dd")),e.R7$(5),e.Y8G("formControl",i.categoriaFiltro),e.R7$(3),e.Y8G("ngForOf",i.categorias),e.R7$(4),e.Y8G("formControl",i.proveedorFiltro),e.R7$(3),e.Y8G("ngForOf",i.proveedores),e.R7$(2),e.Y8G("disabled",i.isLoading),e.R7$(1),e.Y8G("ngIf",i.isLoading),e.R7$(1),e.Y8G("ngIf",!i.isLoading),e.R7$(1),e.SpI(" ",i.isLoading?"Buscando...":"Buscar"," "),e.R7$(1),e.Y8G("ngIf",!i.inventarioActual&&!i.isLoading),e.R7$(1),e.Y8G("ngIf",i.inventarioActual&&!i.isCreatingInventory),e.R7$(1),e.Y8G("ngIf",i.isCreatingInventory),e.R7$(17),e.AVh("selected","barra"===i.areaSeleccionada),e.R7$(8),e.SpI("",i.getCategoriasArea("barra").length," categor\xedas disponibles"),e.R7$(2),e.AVh("selected","cocina"===i.areaSeleccionada),e.R7$(8),e.SpI("",i.getCategoriasArea("cocina").length," categor\xedas disponibles"),e.R7$(1),e.Y8G("ngIf",i.areaSeleccionada),e.R7$(4),e.Y8G("disabled",!i.areaSeleccionada||i.isCreatingInventory),e.R7$(1),e.Y8G("ngIf",i.isCreatingInventory),e.R7$(1),e.Y8G("ngIf",!i.isCreatingInventory),e.R7$(1),e.SpI(" ",i.isCreatingInventory?"Creando...":"Crear Inventario"," "))},dependencies:[b.Sq,b.bT,v.xH,v.y7,v.me,v.Q0,v.wz,v.BC,v.VZ,v.l_,v.vS,b.QX,b.PV,b.oe,b.vh],styles:[".table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#6c757d;border-bottom:2px solid #dee2e6}.table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle;font-size:.875rem}.form-control-sm[_ngcontent-%COMP%]{font-size:.875rem}.badge[_ngcontent-%COMP%]{font-size:.75rem}.text-danger.fw-bold[_ngcontent-%COMP%]{color:#dc3545!important}.text-warning.fw-bold[_ngcontent-%COMP%]{color:#ffc107!important}.text-success.fw-bold[_ngcontent-%COMP%]{color:#198754!important}.card[_ngcontent-%COMP%]{transition:transform .2s ease-in-out}.card[_ngcontent-%COMP%]:hover{transform:translateY(-2px)}.spinner-border[_ngcontent-%COMP%]{width:2rem;height:2rem}@media (max-width: 768px){.table-responsive[_ngcontent-%COMP%]{font-size:.8rem}.form-control-sm[_ngcontent-%COMP%]{width:80px!important}}.is-invalid[_ngcontent-%COMP%]{border-color:#dc3545;box-shadow:0 0 0 .2rem #dc354540}input[type=number][_ngcontent-%COMP%]{text-align:center}input[type=number][_ngcontent-%COMP%]:focus{border-color:#dc3545;box-shadow:0 0 0 .2rem #dc354540}.bi-archive[_ngcontent-%COMP%]{opacity:.5}.btn-outline-danger[_ngcontent-%COMP%]:hover{background-color:#dc3545;border-color:#dc3545}.cursor-pointer[_ngcontent-%COMP%]{cursor:pointer}.area-card[_ngcontent-%COMP%], .categoria-card[_ngcontent-%COMP%]{transition:all .3s ease;border:2px solid transparent}.area-card[_ngcontent-%COMP%]:hover, .categoria-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.area-card.selected[_ngcontent-%COMP%], .categoria-card.selected[_ngcontent-%COMP%]{border-color:var(--bs-primary);background-color:#0d6efd0d}.area-card.selected[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%], .categoria-card.selected[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{background-color:transparent}.area-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:2rem}.area-card[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{transition:transform .3s ease}.area-card[_ngcontent-%COMP%]:hover   i[_ngcontent-%COMP%]{transform:scale(1.1)}.categoria-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:1rem}.btn-group[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{transition:all .2s ease}.btn-group[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]:hover{transform:translateY(-1px)}@media (max-width: 768px){.area-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:1.5rem}.btn-group[_ngcontent-%COMP%]{flex-wrap:wrap}.btn-group[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{margin-bottom:.5rem}}@media (max-width: 576px){.area-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:1rem}.area-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2rem!important}.categoria-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:.75rem}}"]})}}return n})()}];let oe=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.$C({type:n})}static{this.\u0275inj=e.G2t({imports:[P.iI.forChild(ne),P.iI]})}}return n})(),re=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.$C({type:n})}static{this.\u0275inj=e.G2t({imports:[oe,y.PrivateModule,b.MD,v.X1,v.YN]})}}return n})()}}]);